<!DOCTYPE html>
<html lang="en-US">
<head>

	<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge" />	
    <title>Departmental AVL</title>

	<!--Icons (in a folder named "icons")-->
	<link rel="apple-touch-icon" sizes="57x57" href="icons/apple-touch-icon-57x57.png">
	<link rel="apple-touch-icon" sizes="60x60" href="icons/apple-touch-icon-60x60.png">
	<link rel="apple-touch-icon" sizes="72x72" href="icons/apple-touch-icon-72x72.png">
	<link rel="apple-touch-icon" sizes="76x76" href="icons/apple-touch-icon-76x76.png">
	<link rel="apple-touch-icon" sizes="114x114" href="icons/apple-touch-icon-114x114.png">
	<link rel="apple-touch-icon" sizes="120x120" href="icons/apple-touch-icon-120x120.png">
	<link rel="icon" type="image/png" href="icons/favicon-32x32.png" sizes="32x32">
	<link rel="icon" type="image/png" href="icons/favicon-96x96.png" sizes="96x96">
	<link rel="icon" type="image/png" href="icons/favicon-16x16.png" sizes="16x16">
	<link rel="mask-icon" href="icons/safari-pinned-tab.svg" color="#5bbad5">
	<link rel="shortcut icon" href="icons/favicon.ico">
	<link href="https://fonts.googleapis.com/css?family=Roboto:100,300,400,500,700" rel="stylesheet">
	
	<!-- Bootstrap CSS -->
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
	<!-- Night modifications for Bootstrap -->
	<link rel="stylesheet" href="http://avl.cityoflewisville.com/stylesheets/bootstrapNight.css">


	<!-- Custom Stylesheet -->
    <link rel="stylesheet" href="app.css?4">
	
	<!-- JQUERY for LiveData -->
	<script src="https://code.jquery.com/jquery-1.12.4.min.js" integrity="sha256-ZosEbRLbNQzLpnKIkEdrPv7lOy9C27hHQ+Xp8a4MxAQ=" crossorigin="anonymous"></script>
	
	<!-- Vue, development version -->
	<!--<script src="https://cdnjs.cloudflare.com/ajax/libs/vue/1.0.28/vue.js"></script>-->
	
	<!-- Vue, min version -->
	<script src="https://cdnjs.cloudflare.com/ajax/libs/vue/1.0.28/vue.min.js"></script>
	
	<!-- Bootstrap JS -->
	<!--<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>-->
	
	<!-- VueStrap -->
	<script src="https://cdnjs.cloudflare.com/ajax/libs/vue-strap/1.1.36/vue-strap.min.js"></script>
	
	<!-- Lodash -->
	<script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.6.1/lodash.min.js"></script>
	
	<!-- Vue Google Map -->
	<script src="http://avl.cityoflewisville.com/scripts/vue-google-maps-0.1.21.js?1"></script>
	
	<!-- find -->
	<script src="https://cdn.polyfill.io/v2/polyfill.min.js?features=Array.prototype.find,Array.prototype.findIndex"></script>
	
	<!-- vue-resource -->
	<script src="https://cdn.jsdelivr.net/vue.resource/1.0.3/vue-resource.min.js"></script>
	
	<!-- vue-router -->
	<script src="https://cdnjs.cloudflare.com/ajax/libs/vue-router/0.7.13/vue-router.min.js"></script>
	
	<script src="http://avl.cityoflewisville.com/components/zoom-control.js"></script>
	<script src="http://avl.cityoflewisville.com/components/traffic-control.js"></script>
	<script src="http://avl.cityoflewisville.com/components/night-control.js"></script>
	<script src="http://avl.cityoflewisville.com/components/center-control.js"></script>
	<script src="http://avl.cityoflewisville.com/components/traffic-layer.js"></script>
	<script src="http://avl.cityoflewisville.com/components/kml-layer_32.js"></script>
	<script src="http://avl.cityoflewisville.com/components/map-service-layer.js"></script>
	<script src="http://avl.cityoflewisville.com/components/tile-cache-layer.js"></script>
	<script src="http://avl.cityoflewisville.com/components/wms-layer.js"></script>
	<script src="http://avl.cityoflewisville.com/components/map-service-layer-dark.js?1"></script>
	
</head>

<body>

<div id="app" class="container-fluid" :class="[{night: nightMode, addClose: showCloseAll}]">
	<navbar placement="top" type="default">
		<span slot="brand">
			<a class="hidden-xs hidden-md navbar-left"><img class="nav-city-logo" alt="Logo" src="http://avl.cityoflewisville.com/icons/citylogo.svg"/></a>
			<a class="navbar-brand">
				<span v-if="(!initial1)"><span class="hidden-xs">Departmental AVL </span></span>
				<span v-if="(initial1)" class="hidden-xs">{{navTitle1}}</span>
				<span v-if="(initial1)" class="hidden-sm hidden-md hidden-lg">{{navTitle2}}</span>
			</a>
			
			<button-group :value.sync="radioValue" type="default" class="hidden-lg hidden-md btn-group-med navBtn">
				<radio value="Map">Map</radio>
				<radio value="Both">Both</radio>
				<radio value="List">List</radio>
			</button-group>

			<a v-if="(!initial1 || !initial2)" class="pull-right hide-out-collapse"><img class="loading-logo" alt="Loading..." src="http://avl.cityoflewisville.com/icons/loading.gif"/></a>

		</span>

		<li><a><span v-if="(initial1)" class="hidden-xs">{{navTitle2}}</span><span v-if="(initial1)" class="hidden-sm hidden-md hidden-lg">{{navTitle1}}<span></a></li>
		<li><a><span v-if="(initial1)">{{navTitle3}}</span></a></li>
		<li v-show="(isMobile && isAndroid)" class="hide-out-collapse" v-bind:class="[{active: mobileFullscreen}]">
			<a role="button" v-on:click="toggleFullScreen()">Fullscreen<span class="small glyphicon" v-bind:class="[{'glyphicon-resize-full': !(mobileFullscreen), 'glyphicon-resize-small': mobileFullscreen}]"></span></a>
		</li>
		<li v-bind:class="[{active: showGIS}]" class="hidden-xs">
			<a role="button" v-on:click="showGIS=!(showGIS)">GIS Layers <span class="small glyphicon" v-bind:class="[{'glyphicon-remove': showGIS, 'glyphicon-plus': !(showGIS)}]"></span></a>
		</li>
		<li v-bind:class="[{active: showVehicles}]" class="hidden-xs">
			<a role="button" v-on:click="showVehicles=!(showVehicles)">Vehicles <span class="small glyphicon" v-bind:class="[{'glyphicon-remove': showVehicles, 'glyphicon-plus': !(showVehicles)}]"></span></a>
		</li>

		<dropdown text="Settings">
			<li class="dropdown-header">Night Mode</li>
			<li class="li-group" v-bind:class="[{active: setNight == 'OFF'}]"><a v-on:click="setNight='OFF'">OFF <span class="glyphicon glyphicon-ok" v-show="setNight=='OFF'"></span></a></li>
			<!--<li class="li-group" v-bind:class="[{active: setNight == 'AUTO'}]"><a v-on:click="setNight='AUTO'">AUTO <span class="glyphicon glyphicon-ok" v-show="setNight=='AUTO'"></span></a></li>-->
			<li class="li-group" v-bind:class="[{active: setNight == 'ON'}]"><a v-on:click="setNight='ON'">ON <span class="glyphicon glyphicon-ok" v-show="setNight=='ON'"></span></a></li>
		</dropdown>

		<li v-show="showCloseAll"><a role="button" class="closeAll" v-on:click="clickCloseAll">Close All <span class="small glyphicon glyphicon-remove"></span></a></li>

		<a v-if="(!initial1 || !initial2)" class="hide-in-collapse"><img class="loading-logo" alt="Loading..." src="http://avl.cityoflewisville.com/icons/loading.gif"/></a>

		
		<div class="form-group form-group-sm hidden-xs" slot="right">
			<place-input v-on:click="resetAutocomplete" class="form-control input-sm" placeholder="Street Address" :select-first-on-enter="true" :component-restrictions.sync="placeInput.restrictions" :place.sync="placeInput.place" :types.sync="placeInput.types" v-ref:gplaceinput>
			</place-input>
		</div>
	</navbar>
	
	<alert v-bind:show="!(panelsPolling) || !(vehiclesPolling)" placement="top" type="danger" width="300px" dismissable>
		<p v-if="!(panelsPolling)">Polling issues: <span v-if="_Type">{{typePanel}}</span><span v-else>Inspections</span></p>
		<p v-if="!(vehiclesPolling)">Polling issues: Vehicles</p>
	</alert>

	
	<div class="row">
		<div class="col-xs-12" v-bind:class="[{'col-sm-12': !(showGIS || showVehicles), 'col-sm-9': (showGIS || showVehicles), 'col-md-10': (showGIS || showVehicles), 'landscape': isLandscape, 'fullLeft': displayToggle=='List', 'fullRight': displayToggle=='Map'}]">
			<div class="row">
			
				<div id="leftSide" class="col-md-6 col-lg-5" v-show="displayToggle != 'Map'" v-bind:class="[{
					'fullScreen': displayToggle=='List', 'col-xs-6': isLandscape && displayToggle == 'Both'}]">
					<div v-if="(!initial1)">
						<img class="loading-logo center-block" alt="Loading..." src="http://avl.cityoflewisville.com/icons/loading.gif"/>
					</div>
					<div id="listDiv">
						<accordion id="list" one-at-atime="true" v-ref:accordion>
							<panel v-for="panel in sortedPanels" track-by="_ID" :is-open.sync="panel._isOpen" v-on:click="clickPanelList(panel, $event)" :type="panel._PanelClass" id="{{panel._ID}}">
								<span slot="header">
									<strong>{{{spanTitleSize(panel._PanelTitle1)}}}</strong>
									<small class="pull-right smallPanelTitle">{{panel._PanelTitle2}}</small>
									<br>
									<small class="smallPanelTitle">{{{spanHideSmall(panel._PanelTitle3)}}}</small>
									<small class="pull-right smallPanelTitle">{{{spanHideSmall(panel._PanelTitle4)}}}</small>
								</span>
								<span>
									<div v-for="(key, value) in excludeNullValues(panel)" class="row keyRow">
										<div class="col-xs-4 rowTitle">{{{replaceKeyName(key)}}}</div>
										<div class="col-xs-8 {{key}}" style="white-space:pre-wrap;">{{value}}</div>
									</div>
								</span>
							</panel>
						</accordion>
					</div>
					
				</div>
				
				<div id="rightSide" class="col-md-6 col-lg-7" v-show="displayToggle != 'List'" v-bind:class="[{
					'fullScreen': displayToggle=='Map', 'col-xs-6': isLandscape && displayToggle == 'Both'}]">
					<div id="mapDiv">
<!-- UPDATE FOR Google Maps V3.32 - CLarson 8/10/18 remove from map v-on:g-idle="resizeMap"-->
						<map v-if="mapLoaded" :center.sync="centerV" :zoom.sync="zoomV" :bounds.sync="mapBounds" :options="mapOptions" v-on:g-idle="mapIdling" id="map" v-ref:map>
							
							<zoom-control></zoom-control>
							<traffic-control></traffic-control>
							<center-control></center-control>
							
							<marker v-if="placeInput.place.id" :position.sync="placeInput.place.geometry.location" :clickable.sync="true" :draggable.sync="false" :icon="getSearchIcon()" :label="getSearchLabel()" :z-index="1600">
								<info-window :opened.sync="placeInputOpen" :z-index="1600">
									<span>
										{{placeInput.place.formatted_address}}
									</span>
								</info-window>
							</marker>
							
							<!-- accounts for up to 200 vehicles -->
							<marker v-for="vehicle in mappableVehicles" track-by="VehicleID" :position="getLatLng(vehicle.lat, vehicle.lng)" :clickable.sync="true" :draggable.sync="false" :icon="getVehicleIcon(vehicle)" :label="getVehicleLabel(vehicle)" @g-click="clickVehicleMarker(vehicle, $event)" :z-index="getVehicleIndex(vehicle)"> <!--:z-index="getVehicleIndex(vehicle)"-->
								<info-window class="iwStyle" :opened.sync="vehicle.isOpen" :z-index="getVehicleIndex(vehicle)">
									<b class="pull-left" style="margin-bottom:10px;">{{vehicle.label}}</b>
									<table class="table table-condensed">
										<tr v-if="vehicle.radio">
											<td><small>Radio:</small></td><td title="TrackStar ID: {{vehicle.VehicleID}}"><small>{{vehicle.radio}}</small></td>
										</tr>
										<tr v-if="vehicle.VIN">
											<td><small>VIN:</small></td><td><small>{{vehicle.VIN}}</small></td>
										</tr>
										<tr v-if="vehicle.department">
											<td><small>Department:</small></td><td><small>{{vehicle.department}}</small></td>
										</tr>
										<tr v-if="vehicle.division">
											<td><small>Division:</small></td><td><small>{{vehicle.division}}</small></td>
										</tr>
										<tr>
											<td><small>Est Speed:</small></td><td><small>{{vehicle.velocity}}mph&nbsp;{{vehicle.compass}} {{getBearingArrow(vehicle.compass)}}</small></td>
										</tr>
									</table>
									
								</info-window>
							</marker>

							<!-- accounts for up to 200 panels -->
							<marker v-for="panel in mappablePanels" track-by="_ID" :position="getLatLng(panel._Lat, panel._Lng)" :clickable.sync="true" :draggable.sync="false" :icon="getPanelIcon(panel._PointLabel, panel._isOpen)" :label="getPanelMarkerLabel(panel._PointLabel)" @g-click="clickPanelMarker(panel, $event)" :z-index="getCallIndex(call)">
								<info-window :opened.sync="panel._isOpen" :z-index="200" :position="{lat:0, lng:200}">
									<b>{{panel._PanelTitle1}}</b>
									<br>
									<small>{{panel.Address}}</small>
								</info-window>
							</marker>
							
							
							<traffic-layer v-if="showTrafficLayer"></traffic-layer>
							<kml-layer v-if="mapBoundsSet2" v-for="lyr in filterLayersByFiletype('kml')" :layer.sync="lyr"></kml-layer>
							<map-service-layer v-if="mapBoundsSet2" v-for="lyr in filterLayersByFiletype('mapservice')" :layer.sync="lyr"></map-service-layer>
							<tile-cache-layer v-if="mapBoundsSet2" v-for="lyr in filterLayersByFiletype('tilecache')" :layer.sync="lyr"></tile-cache-layer>
							<!--<wms-layer v-if="mapBoundsSet2" v-for="lyr in filterLayersByFiletype('wms')" :layer.sync="lyr"></wms-layer>-->
							<map-service-layer-dark v-if="mapBoundsSet2" v-for="lyr in filterDarkLayersByFiletype('mapservice')" :layer.sync="lyr"></map-service-layer-dark>
						</map>
					</div>

				</div>
				
			</div>
		</div>
		<div v-show="showGIS || showVehicles" class='col-sm-3 col-md-2 hidden-xs' id="extraPanel">
			<div v-show="showGIS" id="layersList">
				<div v-show="chooseGIS == 'GISLayers'">
					<accordion>
						<panel v-for="group in groups" :header="group.name">
							<span>
								<table class="table table-condensed table-hover layersTable">
									<tbody>
										<tr v-for="lyr in filterLayersByGroup(group.id)">
											<td v-on:click="layerToggle(lyr)" colspan="{{lyr.legendshow ? '1': '2'}}" class="layerCell"></> <!--v-bind:class="[{'invalidFileType': !(lyr.isValidFileType)}]"-->
												<small><span class="glyphicon" v-bind:class="[{'glyphicon-plus': !(lyr.active), 'glyphicon-ok': lyr.active}]"></span></small> <!--'glyphicon-ban-circle': !(lyr.isValidFileType)-->
												{{lyr.label}}
												<span class="glyphicon glyphicon-refresh gly-spin" v-if="lyr.isloading"></span>
											</td>
											<td v-if="lyr.legendshow" class="legendCell">
												<button class="btn btn-default btn-xs pull-right" v-if="lyr.active == true && lyr.legend" v-on:click="chooseGIS = lyr.label"><span class="glyphicon glyphicon-menu-hamburger"></span></button>
											</td>
										</tr>
									</tbody>
								</table>
							</span>
						</panel>
					</accordion>
					<button class="btn btn-xs btn-danger pull-right reloadGISButton" v-on:click="loadGISLayers()">Reload GIS Layers</button>
				</div>
				<div v-show="chooseGIS != 'GISLayers'">
					<div v-for="lyr in filterLayers_Legend" v-show="chooseGIS == lyr.label">
						<h4 class="legendTitle"><button class="btn btn-xs btn-default" v-on:click="chooseGIS = 'GISLayers'"><span class="glyphicon glyphicon-remove"></span></button>{{lyr.label}} <small>LEGEND</small></h4>
						<table class="table">
							<thead>
								<tr>
									<th>Symbol</th>
									<th>Value</th>
								</tr>
							</thead>
							<tbody>
								<tr v-for="item in lyr.legend">
									<td><img v-bind:src="'data:' + item.contentType + ';base64,' + item.imageData" v-bind:height="item.height" v-bind:width="item.width"/></td>
									<td>{{item.label}}</td>
								</tr>
							</tbody>
						</table>
					</div>
				</div>
			</div>

			<div v-show="showVehicles" id="vehicleList">
				<panel header="Vehicles">
					<span>
						<a class="list-group-item" v-for="vehicle in data2.Vehicles" v-on:click="clickVehicleList(vehicle, $event)">
							<h5 class="list-group-item-heading"><strong>{{vehicle.label}}</strong>  <span v-if="!(vehicle.isrecent)" class="glyphicon glyphicon-time"></span></h5>
							
							<ul class="list-group-item-text list-unstyled" v-if="vehicle.isOpen">
								<li v-if="vehicle.radio">Radio: {{vehicle.radio}}</li>
								<li v-if="vehicle.MakeModel">Make/Model: {{vehicle.MakeModel}}</li>
								<li v-if="vehicle.VIN">VIN: {{vehicle.VIN}}</li>
								<li v-if="vehicle.deptid">Department: <span v-if="vehicle.department">{{vehicle.department}} </span>({{vehicle.deptid}})</li>
								<li v-if="vehicle.divid">Division: <span v-if="vehicle.division">{{vehicle.division}} </span>({{vehicle.divid}})</li>
								<li v-if="!(vehicle.isrecent)">Last Ping: {{vehicle.latlngtime}}</li>
								<li>TrackStar ID: {{vehicle.VehicleID}}</li>
							</ul>
						</a>
					</span>
				</panel>
			</div>
		</div>
	</div>
</div>


<script>

//Vue.use(VueRouter)

VueGoogleMap.load({
	key: 'AIzaSyDARduaVDhGG5z3_D54raucZWFABj2PFvE',
	v: '3.32',
	libraries: 'places,drawing',
});

//document.addEventListener('DOMContentLoaded', function(){

Vue.component('navbar', VueStrap.navbar);
Vue.component('accordion', VueStrap.accordion);
Vue.component('panel', VueStrap.panel);
Vue.component('radio', VueStrap.radio);
Vue.component('button-group', VueStrap.buttonGroup);
Vue.component('dropdown', VueStrap.dropdown);
Vue.component('checkbox', VueStrap.checkbox);
Vue.component('alert', VueStrap.alert);
Vue.component('bsinput', VueStrap.input);

Vue.component('map', VueGoogleMap.Map);
Vue.component('marker', VueGoogleMap.Marker);
Vue.component('cluster', VueGoogleMap.Cluster);
Vue.component('info-window', VueGoogleMap.InfoWindow);
Vue.component('place-input', VueGoogleMap.PlaceInput);

	
var app = window.app = new Vue({
	el: '#app',
	data: {
		orgCode: '',
		panelsPolling: true,
		panelsPollingSec: 10,
		vehiclesPolling: true,
		vehiclesPollingSec: 1,
		initial1: false,
		initial2: false,
		data: {Title: [], Panels: []},
		data2: {Vehicles:[]},
		layers: [],
		layersToggleOrder: [],
		layersMapTypeOrder: [],
		countActiveLayers: 0,	// what what this going to be used for?

		/* map variables */
		centerV: {lat: 33.04874516100256, lng: -96.9571323598633},
		zoomV: 13,
		mapBounds: {},	// is this anything
		centerDefault: {lat: 33.04874516100256, lng: -96.9571323598633},
		
		countOpenIndex: 1600,
		
		/* views */
		radioValue: 'Both',
		// GIS layers
		showGIS: false,
		chooseGIS: 'GISLayers',
		showVehicles: false,
		/* options */
		showTrafficLayer: false,
		setNight: 'OFF',
		nightMode: false,
		
		// input
		placeInputOpen: false,
		placeInput: {place:{name:''}, types: [], restrictions: {'country':'us'}},
		
		fullHeight: document.documentElement.clientHeight,
		fullWidth: document.documentElement.clientWidth,
		isMobile: false,
		isAndroid: false,
		mobileFullscreen: false,
		
		/* TRYING TO FIX CENTERING ISSUE */
		mapLoaded: false,
		mapBoundsSet: false,
		mapBoundsSet2: false,
		centerSW: {lat: 33.009298, lng: -97.036123},
		centerNE: {lat: 33.071864, lng: -96.893458},

		/*mapstyle*/
		night: [
			{elementType: 'geometry', stylers: [{color: '#000000'}]},
			{elementType: 'labels.text.stroke', stylers: [{color: '#242f3e'}]},
			{elementType: 'labels.text.fill', stylers: [{color: '#746855'}]},
			{featureType: 'administrative.locality', elementType: 'labels.text.fill', stylers: [{color: '#d59563'}]},
			{featureType: 'poi', elementType: 'labels.text.fill', stylers: [{color: '#d59563'}]},
			{featureType: 'poi.park', elementType: 'geometry', stylers: [{color: '#1a331a'}]},
			{featureType: 'poi.park', elementType: 'labels.text.fill', stylers: [{color: '#3c763d'}]},
			{featureType: 'poi.park', elementType: 'labels.text.stroke', stylers: [{visibility: 'off'}]},
			{featureType: 'road', elementType: 'geometry', stylers: [{color: '#38414e'}]},
			{featureType: 'road', elementType: 'geometry.stroke', stylers: [{color: '#212a37'}]},
			{featureType: 'road', elementType: 'labels.text.fill', stylers: [{color: '#9ca5b3'}]},
			{featureType: 'road.highway', elementType: 'geometry', stylers: [{color: '#746855'}]},
			{featureType: 'road.highway', elementType: 'geometry.stroke', stylers: [{color: '#1f2835'}]},
			{featureType: 'road.highway', elementType: 'labels.text.fill', stylers: [{color: '#f3d19c'}]},
			{featureType: 'transit', elementType: 'geometry', stylers: [{color: '#2f3948'}]},
			{featureType: 'transit.station', elementType: 'labels.text.fill', stylers: [{color: '#d59563'}]},
			{featureType: 'water', elementType: 'geometry', stylers: [{color: '#0d1d26'}]},
			{featureType: 'water', elementType: 'labels.text.fill', stylers: [{color: '#31708f'}]},
			{featureType: 'water', elementType: 'labels.text.stroke', stylers: [{visibility: 'off'}]}
		],
	},
	
	watch:{
		mapBounds: function(newVal, oldVal){
			if(newVal){
				this.mapBoundsSet = true;
				//console.log(newVal.getSouthWest().lng() + ', ' + newVal.getNorthEast().lng());
			}
		},
		mapBoundsSet: function(newVal, oldVal){
			//console.log("mbs");
			if(!oldVal && newVal){
				//console.log('bub');
				this.mapBoundsSet2 = true;
			}
		},
		mapLoaded: function(newVal, oldVal){
			//console.log("mapLoaded");
		},
		showTrafficLayer: function(newVal, oldVal){
			if (newVal != oldVal){
				if(newVal){
					$("#traffic").addClass("controlBold");
				}
				else{
					$("#traffic").removeClass("controlBold");
				}
			}
		},
		setNight: function(newVal, oldVal){
			if (newVal != oldVal){
				if (newVal == 'OFF'){
					this.nightMode = false;
				}
				else if (newVal == 'ON'){
					this.nightMode = true;
				}
				/*else if (newVal == 'AUTO'){
					this.setDate();
				}*/
			}
		},
		'placeInput.place': function(newVal, oldVal){
			//console.log("PLACECHANGE");
			if (newVal.name != oldVal.name){
				if(newVal.name){
					if (this.zoomV < 15){
						this.zoomV = 15;
					}
					//console.log("centerV PLACECHANGE");
					this.centerV = newVal.geometry.location;
					this.placeInputOpen = true;
				}
			}
		},
	},
	computed: {
		currentRoute: function(){
			var route = '';

			if(this.orgCode != ''){
				route += 'orgcode=' + this.orgCode;
			}

			// Views

			if(this.radioValue != 'Both'){
				if( this.orgCode != ''){
					route += '&';
				}
				route += 'view=' + this.radioValue.toLowerCase();
			}
			if(this.showGIS){
				if( this.orgCode != '' || this.radioValue != 'Both'){
					route += '&';
				}
				route += 'layers';
			}
			if(this.showVehicles){
				if( this.orgCode != '' || this.radioValue != 'Both' || this.showGIS ){
					route += '&';
				}
				route += 'vehicles';
			}

			// Options
			
			if(this.showTrafficLayer){
				if( this.orgCode != '' || this.radioValue != 'Both' || this.showGIS || this.showVehicles ){
					route += '&';
				}
				route += 'traffic';
			}

			if(this.setNight != 'OFF'){
				if( this.orgCode != '' || this.radioValue != 'Both' || this.showGIS || this.showVehicles || this.showTrafficLayer ){
					route += '&';
				}
				route += 'night=' + this.setNight.toLowerCase();
			}
			
			return route;
		},
	
		isLandscape: function(){
			return (this.fullWidth > this.fullHeight);
		},
		isStacked: function(){
			return (this.fullWidth <= 991 );
		},
		displayToggle: function(){
			if(this.isStacked){
				return this.radioValue;
			}
			else{
				return 'Both';
			}
		},

		mapOptions: function(){
			if(!(this.nightMode)){
				return{zoomControl: false, fullscreenControl: false, streetViewControl: true, gestureHandling: 'greedy', styles: null, tilt:0};
			}
			else{
				return{zoomControl: false, fullscreenControl: false, streetViewControl:true, gestureHandling: 'greedy', styles: this.night, tilt:0};
			}
		},

		panelsPollingMS: function(){
			if (this.panelsPollingSec == 'OFF'){
				return 'OFF';
			}
			else{
				return this.panelsPollingSec * 1000;
			}
		},
		vehiclesPollingMS: function(){
			if (this.vehiclesPollingSec == 'OFF'){
				return 'OFF';
			}
			else{
				return this.vehiclesPollingSec * 1000;
			}
		},

		
		navTitle1: function(){
			return this.data.Title[0]._NavbarTitle1;
		},
		navTitle2: function(){
			return this.data.Title[0]._NavbarTitle2;
		},
		navTitle3: function(){
			return this.data.Title[0]._NavbarTitle3;
		},
		typePanel: function(){
			//if(this.data.Title[0]._Type){
				return this.data.Title[0]._Type + 's';
			/*}
			else{
				return 'Unknown';
			}*/
		},
		
		sortedPanels: function(){
			return this.data.Panels.sort(function(a, b){
				return a._ORDER - b._ORDER;
			});
		},
		
		mappablePanels: function(){
			return this.data.Panels.filter(function (panel) {
				return !(!(panel._Lat) || !(panel._Lng));
			});
		},
		
		mappableVehicles: function(){
			return this.data2.Vehicles.filter(function(vehicle){
				return !(!(vehicle.lat) || !(vehicle.lng));
			});
		},

		showCloseAll: function(){
			// determine if more than 1 call open, show/hide close all button
			var p = this.data.Panels.filter(function(panel){
				return panel._isOpen;
			});
			var v = this.data2.Vehicles.filter(function(vehicle){
				return vehicle.isOpen;
			});
			if(p && v){
				return ((p.length + v.length) > 1);
			}
			else if(p){
				return (p.length > 1);
			}
			else if(v){
				return (v.length > 1);
			}
			else{
				return false;
			}
		},


		filterLayers_Active: function(){
			return this.layers.filter(function(lyr){
				return (lyr.active == true);
			}).sort(function(a, b){
				return a.toggleOrder - b.toggleOrder;
			});
		},
		filterLayers_Legend: function(){
			return this.filterLayers_Active.filter(function(lyr){
				return (lyr.filetype.toLowerCase() == 'mapservice' && lyr.legendshow.toLowerCase() == "true" && (lyr.legend.length > 0) );
			}).sort(function(a, b){
				return a.toggleOrder - b.toggleOrder;
			});
		},
		groups: function() {
			g = this.layers.map(function(obj) { 
				return {
					id: obj.groupid, 
					name: obj.groupname, 
					order: obj.grouporder
				};
			});
			
			newArr = [];
			origLen = g.length;
			found = false;
			x = 0;
			y = 0;

			for (x = 0; x < origLen; x++) {
				found = false;
				for (y = 0; y < newArr.length; y++) {
					if (g[x].id === newArr[y].id) {
						found = true;
						break;
					}
				}
				if (!found) {
					newArr.push(g[x]);
				}
			}
			return newArr.sort(function(a, b){ return a.order - b.order});
		}
	},
	methods:{
		handleResize: function(event) {
/* UPDATE FOR Google Maps V3.32 - CLarson 8/10/18 */
			this.fullHeight = window.innerHeight || document.documentElement.clientHeight || document.body.clientHeight;
			this.fullWidth = window.innerWidth || document.documentElement.clientWidth || document.body.clientWidth;
		},
/* UPDATE FOR Google Maps V3.32 - CLarson 8/10/18 */
/*comment out		resizeMap: function(){
			this.$broadcast('g-resize-map');
		},*/
		mapIdling: function(){
			//console.log("idling " + this.mapBounds.getSouthWest().lng() + ', ' + this.mapBounds.getNorthEast().lng());
			//this.$broadcast('g-resize-map');
		},
		toggleFullScreen: function() {
		
			var doc = window.document;
			var docEl = doc.documentElement;

			var requestFullScreen = docEl.requestFullscreen || docEl.mozRequestFullScreen || docEl.webkitRequestFullScreen || docEl.msRequestFullscreen;
			var cancelFullScreen = doc.exitFullscreen || doc.mozCancelFullScreen || doc.webkitExitFullscreen || doc.msExitFullscreen;

			if(!doc.fullscreenElement && !doc.mozFullScreenElement && !doc.webkitFullscreenElement && !doc.msFullscreenElement) {
				requestFullScreen.call(docEl);
				this.mobileFullscreen = true;
			}
			else {
				cancelFullScreen.call(doc);
				this.mobileFullscreen = false;
			}
		},
		
		excludeNullValues: function(panel){
			var result = {};
			for(var key in panel){
				if (typeof panel[key] !== 'function') {
					if (key.substring(0, 1) !== "_") {
                        if (panel[key]) {
                            result[key] = panel[key];
                        }
                    }
				}
            };
			return result;
		},
		replaceKeyName: function(key){
			return key.replace("_-_", "_/_").replace(/_/g, " ").replace(" Date", "<span class='date'> Date</span>");
		},
		
		spanHideSmall: function (panelTitle) {
			if(panelTitle.indexOf("<<") > -1){
				return panelTitle.replace("<<", '<span class="hidden-xs">').replace(">>", "</span>");
			}
			else {
				return panelTitle;
			}
		},
		spanTitleSize: function (panelTitle) {
			if (panelTitle.length > 25){
				if(panelTitle.length > 50){
					return panelTitle.substring(0,25) + '<span class="hidden-sm">' + panelTitle.substring(25,50) + '</span>...';
				}
				else{
					return panelTitle.substring(0,25) + '<span class="hidden-md hidden-lg">...</span><span class="hidden-sm">' + panelTitle.substring(25,50) + '</span>';
				}
			}
			else {
				return panelTitle;
			}
		},
		
		filterLayersByFiletype: function(type){
			var self = this;
			return this.filterLayers_Active.filter(function(lyr){
				return lyr.filetype.toLowerCase() == type && !(self.nightMode && lyr.urldark);
			});
		},
		filterDarkLayersByFiletype: function(type){
			var self = this;
			return this.filterLayers_Active.filter(function(lyr){
				return lyr.filetype.toLowerCase() == type && (self.nightMode && lyr.urldark);
			});
		},
		filterLayersByGroup: function(group){
			return this.layers.filter(function(lyr){
				return lyr.groupid === group;
			}).sort(function(a, b){
				return a.grouporderinside - b.grouporderinside;
			});
		},

		getLatLng: function(plat, plng){
			return {lat: plat, lng: plng};
		},
		getBearingArrow: function(_bearing){
			var _arrow = '↑↑'; //'←'  '→'  '↓  ↖  ↗  ↘  ↙'
			if ( ['N'].indexOf(_bearing) > -1 ){_arrow = '↑↑'}
			if ( ['NNE','NE','ENE'].indexOf(_bearing) > -1 ){_arrow = '↓↗'}
			if ( ['E'].indexOf(_bearing) > -1 ){_arrow = '→→'}
			if ( ['ESE','SE','SSE'].indexOf(_bearing) > -1 ){_arrow = '↓↘'}
			if ( ['S'].indexOf(_bearing) > -1 ){_arrow = '↓↓'}
			if ( ['SSW','SW','WSW'].indexOf(_bearing) > -1 ){_arrow = '↓↙'}
			if ( ['W'].indexOf(_bearing) > -1 ){_arrow = '←←'}
			if ( ['WNW','NW','NNW'].indexOf(_bearing) > -1 ){_arrow = '↓↖'}
			return _arrow.substr(1,1);
		},
		
		/* MAP ICONS & LABELS */
		getPanelIcon: function() {
			return {
				url: 'icons/map-marker.png'
			};
		},
		getPanelIndex: function(panel){
			if(panel._isOpen){
				return panel._openIndex;
			}
			else{
				return 400 - panel._ORDER;
			}
		},
		
		getPanelIcon: function(label) {
			var url = 'vehicles/call_v1.png';
			if(label){
				return {
					url: url,
					labelOrigin: new google.maps.Point(25, 5)
				};
			}
			else{
				return {
					url: url,
					labelOrigin: new google.maps.Point(15, 35)
				};
			}
		},
		getPanelMarkerLabel: function(label){
			var vcolor = 'black';
			if(this.nightMode){
				vcolor = '#cccccc';
			}
			if(label){
				return {
					text: label,
					fontFamily: 'Roboto, Arial, sans-serif',
					fontSize: '12px',
					fontWeight: '700',
					color: vcolor
				};
			}
			else{
				return null;
			}
		},
		getVehicleIcon: function(vehicle){
			if (!(vehicle.isrecent)){
				if(!(vehicle.isOpen)){
					return {url: 'vehicles/white1_v1.png', labelOrigin: new google.maps.Point(27,9)};
				}
				else{
					return {url: 'vehicles/gray1_ghost_v1.png', labelOrigin: new google.maps.Point(27,9)};
				}
			}
			else{
				return {url: 'vehicles/purple1_v1.png', labelOrigin: new google.maps.Point(27,9)};
			}
		},
		getVehicleLabel: function(vehicle){
			var vcolor = 'white';
			var vweight = '500';
			if (this.nightMode && !(vehicle.isrecent) && !(vehicle.isOpen)){
				vcolor = '#cccccc';
			}
			else if (!(vehicle.isrecent)){
				vcolor = 'black';
			}
			return {
				text: vehicle.label,
				color: vcolor,
				font: 'Roboto, Arial, sans-serif',
				fontSize: '13px',
				fontWeight: vweight
			};
		},
		getVehicleIndex: function(vehicle){
			var group = 200;
			
			if(vehicle.isOpen){
				return vehicle.openIndex;
			}
			else{
				if (vehicle.isrecent){
					if(vehicle.velocity != 0){
						group = 800;
					}
					else{
						group = 600;
					}
				}
				return group - vehicle.order;
			}
		},

		getSearchIcon: function() {
			return {
				url: this.placeInput.place.icon,
				scaledSize: new google.maps.Size(30,30),
				labelOrigin: new google.maps.Point(15, 35)
			};
		},
		getSearchLabel: function(){
			var vcolor = 'black';
			if(this.nightMode){
				vcolor = '#cccccc';
			}
			return {
				text: this.placeInput.place.name,
				fontFamily: 'Roboto, Arial, sans-serif',
				fontSize: '12px',
				fontWeight: '700',
				color: vcolor
			};
		},
		
		/* EVENTS - CLICK */
		clickCenterMap: function(){
			if(app.centerV.lat != app.centerDefault.lat || app.centerV.lng != app.centerDefault.lng){
				//console.log("centerV clickCenterMap");
				app.centerV = app.centerDefault;
			}
			if(app.zoomV != 13){
				//console.log("zoomV clickCenterMap");
				app.zoomV = 13;
			}
			
			return false;
		},
		clickCloseAll: function(){
			this.data.Panels.forEach(function(panel){
				panel._isOpen = false;
			});
			this.data2.Vehicles.forEach(function(vehicle){
				vehicle.isOpen = false;
			});
			
			this.countOpenIndex = 1600;
			
			return;
		},

		clickPanelMarker: function(panel, e){
			var self = this;
			
			if(!(panel._isOpen)){
				panel._openIndex = self.countOpenIndex + 1;
				self.countOpenIndex++;
				Vue.nextTick(function(){
					self.scrollToPanel(panel);
				});
			}
			
			return;
		},
		clickPanelList: function(panel, e){
			var self = this;

			Vue.nextTick(function(){
				if(panel._isOpen){
					panel._openIndex = self.countOpenIndex + 1;
					self.countOpenIndex++;
					self.centerPanelMarker(panel);
				}
			});
			
			return;
		},
		
		clickVehicleMarker: function(vehicle, e){
			var self = this;
			
			if(!(vehicle.isOpen)){
				vehicle.openIndex = self.countOpenIndex + 1;
				self.countOpenIndex++;
			}
			
			return;
		},
		clickVehicleList: function(vehicle, e){
			var self = this;
			
			if(!(vehicle.isOpen)){

				vehicle.isOpen = true;
			}
			Vue.nextTick(function(){
				if(vehicle.isOpen){
					vehicle.openIndex = self.countOpenIndex + 1;
					self.countOpenIndex++;
				}
			});
			this.centerVehicleMarker(vehicle);
			
			return;
		},
		
		/* FUNCTIONAL */
		scrollToPanel: function(panel){		
			// scroll to panel
			var p = app.$refs.accordion.$children.find(function (pan){
				return pan.$el.id == panel._ID;
			});
			app.$el.querySelector("#leftSide").scrollTop = p.$el.offsetTop;
			
			return;
		},
		
		centerPanelMarker: function(panel){
			// center & zoom to panel marker on map
			if( !(!(panel._Lat) || !(panel._Lng)) ){
				if (this.zoomV < 15){
					this.zoomV = 15;
				}
				this.centerV = this.getLatLng(panel._Lat, panel._Lng);
			}
			return;
		},
		centerVehicleMarker: function(vehicle){
			// center & zoom to vehicle marker on map
			if( !(!(vehicle.lat) || !(vehicle.lng)) ){
				if (this.zoomV < 15){
					this.zoomV = 15;
				}
				this.centerV = this.getLatLng(vehicle.lat, vehicle.lng);
			}
			return;
		},
		
		resetAutocomplete: function(){
			var self = this;
			if(this.placeInput.place.id){
				this.placeInputOpen = false;
				this.placeInput.place = {name:''};
				Vue.nextTick(function(){
					self.$refs.gplaceinput.$els.input.value = self.placeInput.place.name;
				});
			}
			return;
		},
		
		addLayerToggleOrder: function(lyr){
			var len;
			var len2;
			
			lyr.isloading = true;
			
			len = this.layersToggleOrder.push(lyr.id);	// add layer's id to array, returns new array length
			this.countActiveLayers++;
			lyr.toggleOrder = len;	 // set layer toggle order (first will be 1)
			
			if(lyr.filetype.toLowerCase() == "mapservice" || lyr.filetype.toLowerCase() == "kml"){
				lyr.active = true;
			}
			if(lyr.filetype.toLowerCase() == "tilecache"){		// || lyr.filetype.toLowerCase() == "wms"){
				len2 = this.layersMapTypeOrder.push(lyr.id);		// [tilecache & wms] add layer's id to array, returns new array length
				lyr.mapTypeIndex = len2 - 1;
				lyr.active = true;
				//console.log("addLayerToggleOrder " + lyr.id + ": toggleOrder " + lyr.toggleOrder + ", mapTypeIndex " + lyr.mapTypeIndex);
			}
		},
		removeLayerToggleOrder: function(lyr){
			//console.log("removeLayerToggleOrder " + lyr.id + ": toggleOrder " + lyr.toggleOrder + ", mapTypeIndex " + lyr.mapTypeIndex);
			var self = this;
			lyr.active = false;
			var i = this.layersToggleOrder.indexOf(lyr.id);		// find layer's id in array (index start at 0)
			var otherID;
			var otherLyr;
			if(i > -1){
				this.layersToggleOrder.splice(i,1)		// remove layer's id from array
				this.countActiveLayers--;
				lyr.toggleOrder = 0;	// set layer's toggle order to 0
				// for each remaining layer in array, find in app.layers, decrement their toggleOrder
				for(i; i < this.layersToggleOrder.length; i++){
					otherID = self.layersToggleOrder[i];
					otherLyr = self.filterLayers_Active.find(function(oLayer){
						return oLayer.id == otherID;
					})
					if(otherLyr){
						otherLyr.toggleOrder--;
					}
				}
				
				if(lyr.filetype.toLowerCase() == "tilecache"){ 		//|| lyr.filetype.toLowerCase() == "wms"){
					var i2 = this.layersMapTypeOrder.indexOf(lyr.id);		// [tilecache & wms] find layer's id in array (index start at 0)
					if(i2 > -1){
						this.layersMapTypeOrder.splice(i2,1)		// [tilecache & wms] remove layer's id from array
						// [tilecache & wms] for each remaining layer in array, find in app.layers, decrement their toggleOrder
						for(i2; i2 < this.layersMapTypeOrder.length; i2++){
							otherID = self.layersMapTypeOrder[i2];
							otherLyr = self.filterLayers_Active.find(function(oLayer){
								return oLayer.id == otherID;
							})
							if(otherLyr){
								otherLyr.mapTypeIndex--;
							}
						}
					}
					else{
						console.log("layer mapTypeIndex not added");
					}
				}
			}
			else{
				console.log("layer toggleOrder not added");
			}
		},
		layerToggle: function(lyr){
			// DECLARE VARIABLES
			if(lyr.filetype.toLowerCase() == "mapservice" || lyr.filetype.toLowerCase() == "tilecache" || lyr.filetype.toLowerCase() == "kml"){
				var self = this;
				var len;
				
				if(lyr.active === false){
					/*self.countActiveLayers++;
					lyr.toggleOrder = self.countActiveLayers;
					
					if(lyr.filetype.toLowerCase() == "mapservice"){
						lyr.active = true;
					}
					if(lyr.filetype.toLowerCase() == "tilecache"){
						lyr.active = true;
					}
					*/
					this.addLayerToggleOrder(lyr);
					
				}
				else{
					/*lyr.active = false;
					self.countActiveLayers--;
					lyr.toggleOrder = 0;
					*/
					this.removeLayerToggleOrder(lyr);
				}
			}
			return;
		},

		loadGISLayers: function(){
			// Uses vue-resource
			// Get layer information from Google Spreadsheet
			var self = this;
			var lyr;
			//this.$http.get("https://spreadsheets.google.com/feeds/list/1q2t8kR4fme1D0Us2EZmsj3LjBQ2QxD0lfl2db68hF2Q/1/public/values?&alt=json&sq=label%3E%22%22%20and%20id%3C%3E%22ID%22").then(
			$.post('https://query.cityoflewisville.com/v2/',{
				webservice : 'Get Public GIS Layers'
			},
			function(data) {
				//Success Callback
				
				/*self.layers = response.body.feed.entry.map(function(obj, i){
					lyr = {};
					Object.keys(obj).forEach(function(x){
						if(x.substr(0,4)=='gsx$' || x=='updated'){
							if(x == 'gsx$infowindowcolumns'){
								lyr[x.replace('gsx$','')] = obj[x].$t.split(",").map(function(obj){return obj.toLowerCase()});
							}
							else{
								lyr[x.replace('gsx$','')] = obj[x].$t;
							}
						}
					});
				*/

				self.layers = data.layers.map(function(obj, i){
					lyr = {};
					Object.keys(obj).forEach(function(x){
						if(x == 'infowindowcolumns'){
							if(obj[x]){
								lyr[x] = obj[x].split(",").map(function(obj){return obj.toLowerCase()});
							}
							else{
								lyr[x] = obj[x];
							}
						}
						else{
							lyr[x] = obj[x];
						}
					});
					
					// Set other properties for each layer object
					lyr.isloading = false;
					lyr.toggleOrder = parseInt(9 + lyr.id);
					lyr.mapservice = {};
					lyr.legend = [];
					
					// Activate layers if open on load is true
					/*if(lyr.openonload.toLowerCase() == "true"){
						lyr.active = true;
					}
					else{
						lyr.active = false;
					}*/

					lyr.active = false;
					
					return lyr;
				});
				self.layers.forEach(function(lyr){
					if(lyr.openonload){
						self.addLayerToggleOrder(lyr);
					}
				});
				
				
				//console.log(self.layers);
				
			})
			.fail(function(data){
				// error callback
				alert("Error loading GIS Layers - no response from spreadsheet");
			});
		},


		pollingPanels: function(){
			//console.log('polling panels')
			var self = this;
			if(self.orgCode != ''){
				$.post('https://query.cityoflewisville.com/v2/',{
					webservice : 'AVLTemplate',
					OrgGroupCode: self.orgCode
				},
				function(data){
					// initial data
					if(app.data.Panels.length==0){
						app.data = data;
						app.initial1 = true;
						
						app.data.Panels.forEach(function(panel){
							Vue.set(panel, '_isOpen', false);
							Vue.set(panel, '_openIndex', 0);
						});
					}
					
					// added or changed data
					else{
						data.Panels.forEach(function(panel, index){
							var oldPanel = app.data.Panels.find(function (p){
								return p._ID == panel._ID;
							});
							if (!oldPanel){
								// new panel
								panel['_isOpen'] = false;
								panel['_openIndex'] = 0;
							}
							else{
								// panel existed
								panel['_isOpen'] = oldPanel._isOpen;
								panel['_openIndex'] = oldPanel._openIndex;
							}
						});
							
						app.data.Panels = data.Panels;
					}
						
					app.panelsPolling = true;
					setTimeout(app.pollingPanels, app.panelsPollingMS);
				})
				.fail(function(data){
					console.log("panels polling failed");
					app.panelsPolling = false;
					setTimeout(app.pollingPanels, app.panelsPollingMS);
				});
			}
		},
		pollingVehicles: function(){
			//console.log('polling vehicles')
			var self = this;
			if(self.orgCode != ''){
				$.post('https://query.cityoflewisville.com/v2/',{
					webservice : 'AVLTemplate/Vehicles',
					OrgGroupCode: self.orgCode
				},
				function(data){
					//console.log(response.data.Vehicles);		
					data.Vehicles.forEach(function(vehicle, index){
						var i = app.data2.Vehicles.findIndex(function (v){
							return v.VehicleID == vehicle.VehicleID;
						});
						if (i == -1){
							vehicle['isOpen'] = false;
							vehicle['openIndex'] = 0;
						}
						else{
							vehicle['isOpen'] = app.data2.Vehicles[i].isOpen;
							vehicle['openIndex'] = app.data2.Vehicles[i].openIndex;
						}
					});
					
					app.data2.Vehicles = data.Vehicles;
					app.initial2 = true;
					app.vehiclesPolling = true;
					setTimeout(app.pollingVehicles, app.vehiclesPollingMS);
				})
				.fail(function(data){
					console.log("vehicles polling failed");
					app.vehiclesPolling = false;
					setTimeout(app.pollingVehicles, app.vehiclesPollingMS);
				});
			}
		},
	},
	ready: function() {
	
		//console.log(this.$route.query.orgcode);
		//openSocket(this.$route.query.orgcode);
	
		/* USE WHEN LiveData IS NOT NECESSARY */
		/*$.post('https://query.cityoflewisville.com/v2/',
		{webservice : 'AVLTemplate'},
		function(data){
			self.base = true;
			
			self.navTitle1 = data.Title[0]._NavbarTitle1;
			self.navTitle2 = data.Title[0]._NavbarTitle2;
			self.navTitle3 = data.Title[0]._NavbarTitle3;
			
			data.Panels.forEach(function(panel){
				Vue.set(panel, 'isOpen', false);
			});
			self.panels = data.Panels;
		});*/
	
		// Solution: https://github.com/vuejs/vue/issues/1915
		window.addEventListener('resize', this.handleResize);
		var self = this;
		
		if(/(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|ipad|iris|kindle|Android|Silk|lge |maemo|midp|mmp|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows (ce|phone)|xda|xiino/i.test(navigator.userAgent) 
					|| /1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i.test(navigator.userAgent.substr(0,4))
		){
			self.isMobile = true;
		}
		self.isAndroid = navigator.userAgent.toLowerCase().indexOf("android") > -1; //&& ua.indexOf("mobile");
		
		var initialParams = location.hash;
		
		if (initialParams != ""){
			var match;
			
			match = RegExp('orgcode=([^&]*)').exec(initialParams);
			if ( match ){
				console.log(match[1]);
				self.orgCode = match[1];
			}
			
			// Views
			match = RegExp('view=([^&]*)').exec(initialParams);
			if ( match && match[1] == 'map' ){
				self.radioValue = 'Map';
			}
			else if ( match && match[1] == 'list' ){
				self.radioValue = 'List';
			}

			match = RegExp('layers').exec(initialParams);
			if (match){
				// check if user has incorrect params: either layers OR vehicles - cannot be both
				match2 = RegExp('vehicles').exec(initialParams);
				if (match2){
					self.showVehicles = true;
				}
				else{
					self.showGIS = true;
				}
			}
			else{
				match = RegExp('vehicles').exec(initialParams);
				if (match){
					self.showVehicles = true;
				}
			}

			// Options
			
			match = RegExp('traffic').exec(initialParams);
			if (match){
				self.showTrafficLayer = true;
			}
			match = RegExp('night=([^&]*)').exec(initialParams);
			if (match){
				self.setNight = match[1].toUpperCase();
			}
		}

		if(self.orgCode != ''){
			self.pollingPanels();
			self.pollingVehicles();
		}
		

		// Add watches after the initial set from URL parameters
		// Wait, why not on the inital set??? - 4/27
		
		self.$watch('radioValue', function(newVal, oldVal){
/* UPDATE FOR Google Maps V3.32 - CLarson 8/10/18 */
			//console.log("radioValue");
//comment out			self.$broadcast('g-resize-map');
		})
		self.$watch('showGIS', function(newVal, oldVal){
			//console.log("showGIS");
/* UPDATE FOR Google Maps V3.32 - CLarson 8/10/18 */
//comment out			self.$broadcast('g-resize-map');
			
			if(newVal && self.showVehicles){
				self.showVehicles = !(self.showVehicles);
			}
		})
		self.$watch('showVehicles', function(newVal, oldVal){
/* UPDATE FOR Google Maps V3.32 - CLarson 8/10/18 */
			//console.log("showVehicles");
//comment out			self.$broadcast('g-resize-map');
			if(newVal && self.showGIS){
				self.showGIS = !(self.showGIS);
			}
		})

		
		// Add watch to currentRoute to update hash for future changes
		self.$watch('currentRoute', function(newVal, oldVal){
			location.hash = newVal;
		})
		
		// Uses vue-resource
		// Get layer information from Google Spreadsheet
		this.loadGISLayers();
		
		VueGoogleMap.loaded.then(function(map) {
			//console.log('the google map library has been loaded');
			self.mapLoaded = true;
		})
		
	},
	 beforeDestroy: function () {
		window.removeEventListener('resize', this.handleResize);
	},
});


// When vue google maps loads, vueGoogleMapsInit is the callback
// Add arcgis, then callback arcGISInit
// vue-google-maps.js file is modified to resolve the promise after window.arcGISInit
var vueGoogleMapsInit = function(){
	//console.log("vueGoogleMapsInit");
	var script = document.createElement( "script" );
	script.type = "text/javascript";
	if(script.readyState) {  //IE
		script.onreadystatechange = function() {
			if ( script.readyState === "loaded" || script.readyState === "complete" ) {
				script.onreadystatechange = null;
				arcGISInit();
			}
		};
	}
	else {  //Others
		script.onload = function() {
			arcGISInit();
		};
	}

	script.src = 'http://avl.cityoflewisville.com/scripts/arcgislink3.32_8-17.js';
	document.body.appendChild( script );
}
	
</script>


</body>
</html>